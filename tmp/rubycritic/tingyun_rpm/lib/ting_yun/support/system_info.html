<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>RubyCritic</title>
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <header class="project-header group">
      <div class="container">
        <h1 class="logo"><a href="../../../../overview.html" class="logo-link">RubyCritic</a></h1>
        <nav class="project-nav">
          <a href="../../../../overview.html" class="project-nav-item">Overview</a>
          <a href="../../../../code_index.html" class="project-nav-item">Code</a>
          <a href="../../../../smells_index.html" class="project-nav-item">Smells</a>
        </nav>
      </div>
    </header>
    <div class="container">
      <div class="file-header group rated">
  <span class="rating rating-c circled-text circle">
    C
  </span>
  <h2 class="file-name">TingYun::Support::SystemInfo</h2>

  <span class="file-committed-at">
    
      Updated <time class='js-timeago' datetime='2016-04-29 02:35:55 +0000'>2016-04-29 02:35:55 +0000</time>
    
  </span>

  <div class="file-stats group">
    <div class="file-stat">
      151 complexity
    </div>
    <div class="file-stat">
      10.8 complexity per method
    </div>
    <div class="file-stat">
      6 churn
    </div>
    <div class="file-stat">
      14 methods
    </div>
    <div class="file-stat">
      0 duplication
    </div>
  </div>

  
    <button id="js-toggle-smells" class="smells-toggle-button button">Toggle Smells</button>
  
</div>

<code class="prettyprint linenums lang-ruby file-code js-file-code"># encoding: utf-8

require &#39;rbconfig&#39;

module TingYun
  module Support
    module SystemInfo<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank">IrresponsibleModule</a>)      TingYun::Support::SystemInfo has no descriptive comment          </span>  </li></ul>
      def self.ruby_os_identifier
        RbConfig::CONFIG[&#39;target_os&#39;]
      end

      def self.clear_processor_info
        @processor_info = nil
      end

      def self.get_processor_info<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">HighComplexity</a>)      TingYun::Support::SystemInfo::get_processor_info has a flog score of 57          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::Support::SystemInfo#self.get_processor_info has approx 13 statements          </span>  </li></ul>
        if @processor_info.nil?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank">NilCheck</a>)      TingYun::Support::SystemInfo#self.get_processor_info performs a nil-check          </span>  </li></ul>
          case ruby_os_identifier

            when /darwin/
              @processor_info = {
                  :num_physical_packages  =&gt; sysctl_value(&#39;hw.packages&#39;).to_i,
                  :num_physical_cores     =&gt; sysctl_value(&#39;hw.physicalcpu_max&#39;).to_i,
                  :num_logical_processors =&gt; sysctl_value(&#39;hw.logicalcpu_max&#39;).to_i
              }
              # in case those don&#39;t work, try backup values
              if @processor_info[:num_physical_cores] &lt;= 0
                @processor_info[:num_physical_cores] = sysctl_value(&#39;hw.physicalcpu&#39;).to_i
              end
              if @processor_info[:num_logical_processors] &lt;= 0<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls @processor_info[:num_logical_processors] 2 times                        <a href="system_info.html#L30" class="js-smell-location">0</a>                  <a href="system_info.html#L33" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls @processor_info[:num_logical_processors] <= 0 2 times                        <a href="system_info.html#L30" class="js-smell-location">0</a>                  <a href="system_info.html#L33" class="js-smell-location">1</a>                  </span>  </li></ul>
                @processor_info[:num_logical_processors] = sysctl_value(&#39;hw.logicalcpu&#39;).to_i
              end
              if @processor_info[:num_logical_processors] &lt;= 0<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls @processor_info[:num_logical_processors] 2 times                        <a href="system_info.html#L30" class="js-smell-location">0</a>                  <a href="system_info.html#L33" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls @processor_info[:num_logical_processors] <= 0 2 times                        <a href="system_info.html#L30" class="js-smell-location">0</a>                  <a href="system_info.html#L33" class="js-smell-location">1</a>                  </span>  </li></ul>
                @processor_info[:num_logical_processors] = sysctl_value(&#39;hw.ncpu&#39;).to_i<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls sysctl_value('hw.ncpu') 2 times                        <a href="system_info.html#L34" class="js-smell-location">0</a>                  <a href="system_info.html#L45" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls sysctl_value('hw.ncpu').to_i 2 times                        <a href="system_info.html#L34" class="js-smell-location">0</a>                  <a href="system_info.html#L45" class="js-smell-location">1</a>                  </span>  </li></ul>
              end

            when /linux/
              cpuinfo = proc_try_read(&#39;/proc/cpuinfo&#39;)
              @processor_info = cpuinfo ? parse_cpuinfo(cpuinfo) : {}

            when /freebsd/
              @processor_info = {
                  :num_physical_packages  =&gt; nil,
                  :num_physical_cores     =&gt; nil,
                  :num_logical_processors =&gt; sysctl_value(&#39;hw.ncpu&#39;).to_i<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls sysctl_value('hw.ncpu') 2 times                        <a href="system_info.html#L34" class="js-smell-location">0</a>                  <a href="system_info.html#L45" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.get_processor_info calls sysctl_value('hw.ncpu').to_i 2 times                        <a href="system_info.html#L34" class="js-smell-location">0</a>                  <a href="system_info.html#L45" class="js-smell-location">1</a>                  </span>  </li></ul>
              }
          end

          # give nils for obviously wrong values
          @processor_info.keys.each do |key|
            value = @processor_info[key]
            if value.is_a?(Numeric) &amp;&amp; value &lt;= 0
              @processor_info[key] = nil
            end
          end
        end

        @processor_info
      rescue
        {}
      end

      def self.sysctl_value(name)
        # make sure to redirect stderr so we don&#39;t spew if the name is unknown
        `sysctl -n #{name} 2&gt;/dev/null`
      end

      def self.parse_cpuinfo(cpuinfo)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">HighComplexity</a>)      TingYun::Support::SystemInfo::parse_cpuinfo has a flog score of 42          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo has approx 19 statements          </span>  </li></ul>
        # Build a hash of the form
        #   { [phys_id, core_id] =&gt; num_logical_processors_on_this_core }
        cores = Hash.new(0)
        phys_id = core_id = nil

        total_processors = 0

        cpuinfo.split(&quot;\n&quot;).map(&amp;:strip).each do |line|
          case line
            when /^processor\s*:/
              cores[[phys_id, core_id]] += 1 if phys_id &amp;&amp; core_id<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls cores[[phys_id, core_id]] 2 times                        <a href="system_info.html#L79" class="js-smell-location">0</a>                  <a href="system_info.html#L88" class="js-smell-location">1</a>                  </span>  </li></ul>
              phys_id = core_id = nil # reset these values
              total_processors += 1
            when /^physical id\s*:(.*)/
              phys_id = $1.strip.to_i<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls $1.strip 2 times                        <a href="system_info.html#L83" class="js-smell-location">0</a>                  <a href="system_info.html#L85" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls $1.strip.to_i 2 times                        <a href="system_info.html#L83" class="js-smell-location">0</a>                  <a href="system_info.html#L85" class="js-smell-location">1</a>                  </span>  </li></ul>
            when /^core id\s*:(.*)/
              core_id = $1.strip.to_i<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls $1.strip 2 times                        <a href="system_info.html#L83" class="js-smell-location">0</a>                  <a href="system_info.html#L85" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls $1.strip.to_i 2 times                        <a href="system_info.html#L83" class="js-smell-location">0</a>                  <a href="system_info.html#L85" class="js-smell-location">1</a>                  </span>  </li></ul>
          end
        end
        cores[[phys_id, core_id]] += 1 if phys_id &amp;&amp; core_id<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Support::SystemInfo#self.parse_cpuinfo calls cores[[phys_id, core_id]] 2 times                        <a href="system_info.html#L79" class="js-smell-location">0</a>                  <a href="system_info.html#L88" class="js-smell-location">1</a>                  </span>  </li></ul>

        num_physical_packages  = cores.keys.map(&amp;:first).uniq.size
        num_physical_cores     = cores.size
        num_logical_processors = cores.values.reduce(0,:+)

        if num_physical_cores == 0
          num_logical_processors = total_processors

          if total_processors == 1
            # Some older, single-core processors might not list ids,
            # so we&#39;ll just mark them all 1.
            num_physical_packages = 1
            num_physical_cores    = 1
          else
            # We have no way of knowing how many packages or cores
            # we have, even though we know how many processors there are.
            num_physical_packages = nil
            num_physical_cores    = nil
          end
        end

        {
            :num_physical_packages  =&gt; num_physical_packages,
            :num_physical_cores     =&gt; num_physical_cores,
            :num_logical_processors =&gt; num_logical_processors
        }
      end

      def self.num_physical_packages ; get_processor_info[:num_physical_packages ] end
      def self.num_physical_cores    ; get_processor_info[:num_physical_cores    ] end
      def self.num_logical_processors
        processor_count = get_processor_info[:num_logical_processors]

        if processor_count.nil?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank">NilCheck</a>)      TingYun::Support::SystemInfo#self.num_logical_processors performs a nil-check          </span>  </li></ul>
          TingYun::Agent.logger.warn(&quot;Failed to determine processor count, assuming 1&quot;)
          processor_count = 1
        end

        processor_count
      end

      def self.processor_arch
        RbConfig::CONFIG[&#39;target_cpu&#39;]
      end

      def self.os_version
        proc_try_read(&#39;/proc/version&#39;)
      end

      def self.docker_container_id
        return unless ruby_os_identifier =~ /linux/

        cgroup_info = proc_try_read(&#39;/proc/self/cgroup&#39;)
        return unless cgroup_info

        parse_docker_container_id(cgroup_info)
      end

      def self.parse_docker_container_id(cgroup_info)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::Support::SystemInfo#self.parse_docker_container_id has approx 8 statements          </span>  </li></ul>
        cpu_cgroup = parse_cgroup_ids(cgroup_info)[&#39;cpu&#39;]
        return unless cpu_cgroup

        case cpu_cgroup
          # docker native driver w/out systemd (fs)
          when %r{^/docker/([0-9a-f]+)$}                      then $1
          # docker native driver with systemd
          when %r{^/system\.slice/docker-([0-9a-f]+)\.scope$} then $1
          # docker lxc driver
          when %r{^/lxc/([0-9a-f]+)$}                         then $1
          # not in any cgroup
          when &#39;/&#39;                                            then nil
          # in a cgroup, but we don&#39;t recognize its format
          else
            TingYun::Agent.logger.debug(&quot;Ignoring unrecognized cgroup ID format: &#39;#{cpu_cgroup}&#39;&quot;)
            nil
        end
      end

      def self.parse_cgroup_ids(cgroup_info)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::Support::SystemInfo#self.parse_cgroup_ids has approx 9 statements          </span>  </li></ul>
        cgroup_ids = {}

        cgroup_info.split(&quot;\n&quot;).each do |line|
          parts = line.split(&#39;:&#39;)
          next unless parts.size == 3
          _, subsystems, cgroup_id = parts
          subsystems = subsystems.split(&#39;,&#39;)
          subsystems.each do |subsystem|<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank">NestedIterators</a>)      TingYun::Support::SystemInfo#self.parse_cgroup_ids contains iterators nested 2 deep          </span>  </li></ul>
            cgroup_ids[subsystem] = cgroup_id
          end
        end

        cgroup_ids
      end

      # A File.read against /(proc|sysfs)/* can hang with some older Linuxes.
      # See https://bugzilla.redhat.com/show_bug.cgi?id=604887, RUBY-736, and
      # https://github.com/opscode/ohai/commit/518d56a6cb7d021b47ed3d691ecf7fba7f74a6a7
      # for details on why we do it this way.
      def self.proc_try_read(path)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::Support::SystemInfo#self.proc_try_read has approx 9 statements          </span>  </li></ul>
        return nil unless File.exist?(path)
        content = &#39;&#39;
        File.open(path) do |f|<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank">UncommunicativeVariableName</a>)      TingYun::Support::SystemInfo#self.proc_try_read has the variable name 'f'          </span>  </li></ul>
          loop do
            begin
              content &lt;&lt; f.read_nonblock(4096)
            rescue EOFError
              break
            rescue Errno::EWOULDBLOCK, Errno::EAGAIN
              content = nil
              break # don&#39;t select file handle, just give up
            end
          end
        end
        content
      end
    end
  end
end
</code>

    </div>
    <script src='../../../../assets/javascripts/jquery-2.1.0.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.js'></script>
    <script src='../../../../assets/javascripts/jquery.floatThead-v1.2.7.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago-v1.4.1.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo-1.4.11.js'></script>
    <script src='../../../../assets/javascripts/prettify-4-Mar-2013.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
  </body>
</html>
