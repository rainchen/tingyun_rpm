<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>RubyCritic</title>
    <link href="../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <header class="project-header group">
      <div class="container">
        <h1 class="logo"><a href="../../../../overview.html" class="logo-link">RubyCritic</a></h1>
        <nav class="project-nav">
          <a href="../../../../overview.html" class="project-nav-item">Overview</a>
          <a href="../../../../code_index.html" class="project-nav-item">Code</a>
          <a href="../../../../smells_index.html" class="project-nav-item">Smells</a>
        </nav>
      </div>
    </header>
    <div class="container">
      <div class="file-header group rated">
  <span class="rating rating-c circled-text circle">
    C
  </span>
  <h2 class="file-name">TingYun::TingYunService::UploadService</h2>

  <span class="file-committed-at">
    
      Updated <time class='js-timeago' datetime='2016-08-18 15:03:03 +0800'>2016-08-18 15:03:03 +0800</time>
    
  </span>

  <div class="file-stats group">
    <div class="file-stat">
      138 complexity
    </div>
    <div class="file-stat">
      13.8 complexity per method
    </div>
    <div class="file-stat">
      39 churn
    </div>
    <div class="file-stat">
      10 methods
    </div>
    <div class="file-stat">
      0 duplication
    </div>
  </div>

  
    <button id="js-toggle-smells" class="smells-toggle-button button">Toggle Smells</button>
  
</div>

<code class="prettyprint linenums lang-ruby file-code js-file-code"># encoding: utf-8
require &#39;ting_yun/metrics/metric_spec&#39;
require &#39;ting_yun/metrics/metric_data&#39;
require &#39;ting_yun/support/serialize/encodes&#39;

module TingYun
  class TingYunService<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank">IrresponsibleModule</a>)      TingYun::TingYunService has no descriptive comment          </span>  </li></ul>
    module UploadService<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank">IrresponsibleModule</a>)      TingYun::TingYunService::UploadService has no descriptive comment          </span>  </li></ul>

      EMPTY_PARENT = &#39;&#39;.freeze
      def compressed_json
        TingYun::Support::Serialize::Encoders::CompressedJSON
      end

      def base64_compressed_json
        TingYun::Support::Serialize::Encoders::Base64CompressedJSON
      end

      def json
        TingYun::Support::Serialize::Encoders::Json
      end

      def metric_data(stats_hash)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::TingYunService::UploadService#metric_data has approx 7 statements          </span>  </li></ul>

        timeslice_start = stats_hash.started_at
        timeslice_end = stats_hash.harvested_at || Time.now

        action_array, adpex_array, general_array, components_array, errors_array = build_metric_data_array(stats_hash)

        upload_data = {
            :type =&gt; &#39;perfMetrics&#39;,
            :timeFrom =&gt; timeslice_start.to_i,
            :timeTo =&gt; timeslice_end.to_i,
            :interval =&gt; 60,
            :actions =&gt; action_array,
            :apdex =&gt; adpex_array,
            :components =&gt; components_array,
            :general =&gt; general_array,
            :errors  =&gt; errors_array
        }
        result = invoke_remote(:upload, [upload_data])
        fill_metric_id_cache(result)
        result
      end

      # The collector wants to recieve metric data in a format that&#39;s different
      # from how we store it inte -nally, so this method handles the translation.
      # It also handles translating metric names to IDs using our metric ID cache.
      def build_metric_data_array(stats_hash)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">VeryHighComplexity</a>)      TingYun::TingYunService::UploadService#build_metric_data_array has a flog score of 86          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Statements.md" target="_blank">TooManyStatements</a>)      TingYun::TingYunService::UploadService#build_metric_data_array has approx 20 statements          </span>  </li></ul>
        action_array = []
        adpex_array = []
        general_array = []
        components_array = []
        errors_array = []
        stats_hash.each do |metric_spec, stats|

          # Omit empty stats as an optimization
          unless stats.is_reset?
            metric_id = metric_id_cache[metric_spec.hash]<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>

            if metric_spec.name.start_with?(&#39;WebAction&#39;,&#39;BackgroundAction&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              action_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)
            elsif metric_spec.name.start_with?(&#39;Apdex&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              adpex_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)
            elsif metric_spec.name.start_with?(&#39;Errors&#39;) &amp;&amp; metric_spec.scope.empty?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope.empty? 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              errors_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)
            elsif metric_spec.name.start_with?(&#39;Database&#39;,&#39;View&#39;,&#39;MongoDB&#39;,&#39;Redis&#39;,&#39;Memcached&#39;,&#39;External&#39;,&#39;Nested&#39;, &#39;CPU&#39;, &#39;Memory&#39;, &#39;WebFrontend&#39;,&#39;Rake&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              if metric_spec.scope.empty?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope.empty? 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                general_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls general_array << TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id) 2 times                        <a href="upload_service.html#L69" class="js-smell-location">0</a>                  <a href="upload_service.html#L77" class="js-smell-location">1</a>                  </span>  </li></ul>
              else
                components_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id) unless metric_spec.name.start_with?(&#39;External/NULL&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls components_array << TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id) 2 times                        <a href="upload_service.html#L71" class="js-smell-location">0</a>                  <a href="upload_service.html#L82" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              end
            elsif metric_spec.name.start_with?(&#39;cross_app&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              external =  metric_spec.name.split(&#39;;&#39;)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.name 7 times                        <a href="upload_service.html#L61" class="js-smell-location">0</a>                  <a href="upload_service.html#L63" class="js-smell-location">1</a>                  <a href="upload_service.html#L65" class="js-smell-location">2</a>                  <a href="upload_service.html#L67" class="js-smell-location">3</a>                  <a href="upload_service.html#L71" class="js-smell-location">4</a>                  <a href="upload_service.html#L73" class="js-smell-location">5</a>                  <a href="upload_service.html#L74" class="js-smell-location">6</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
              if metric_spec.scope.empty?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls metric_spec.scope.empty? 3 times                        <a href="upload_service.html#L65" class="js-smell-location">0</a>                  <a href="upload_service.html#L68" class="js-smell-location">1</a>                  <a href="upload_service.html#L75" class="js-smell-location">2</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                metric_spec.name = &quot;ExternalTransaction/NULL/#{external[1]}&quot;<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls external[1] 2 times                        <a href="upload_service.html#L76" class="js-smell-location">0</a>                  <a href="upload_service.html#L80" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                general_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls general_array << TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id) 2 times                        <a href="upload_service.html#L69" class="js-smell-location">0</a>                  <a href="upload_service.html#L77" class="js-smell-location">1</a>                  </span>  </li></ul>
              else
                metric_spec.name = &quot;External/#{external[3]}&quot;<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                metric_spec.calleeId = external[1]<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls external[1] 2 times                        <a href="upload_service.html#L76" class="js-smell-location">0</a>                  <a href="upload_service.html#L80" class="js-smell-location">1</a>                  </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                metric_spec.calleeName = external[2]<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#build_metric_data_array refers to metric_spec more than self (maybe move it to another class?)                        <a href="upload_service.html#L59" class="js-smell-location">0</a>                  <a href="upload_service.html#L61" class="js-smell-location">1</a>                  <a href="upload_service.html#L63" class="js-smell-location">2</a>                  <a href="upload_service.html#L65" class="js-smell-location">3</a>                  <a href="upload_service.html#L67" class="js-smell-location">4</a>                  <a href="upload_service.html#L68" class="js-smell-location">5</a>                  <a href="upload_service.html#L71" class="js-smell-location">6</a>                  <a href="upload_service.html#L73" class="js-smell-location">7</a>                  <a href="upload_service.html#L74" class="js-smell-location">8</a>                  <a href="upload_service.html#L75" class="js-smell-location">9</a>                  <a href="upload_service.html#L76" class="js-smell-location">10</a>                  <a href="upload_service.html#L79" class="js-smell-location">11</a>                  <a href="upload_service.html#L80" class="js-smell-location">12</a>                  <a href="upload_service.html#L81" class="js-smell-location">13</a>                  </span>  </li></ul>
                components_array &lt;&lt; TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#build_metric_data_array calls components_array << TingYun::Metrics::MetricData.new(metric_spec, stats, metric_id) 2 times                        <a href="upload_service.html#L71" class="js-smell-location">0</a>                  <a href="upload_service.html#L82" class="js-smell-location">1</a>                  </span>  </li></ul>
              end

            end
          end
        end

        [action_array, adpex_array, general_array, components_array, errors_array]
      end


      # takes an array of arrays of spec and id, adds it into the
      # metric cache so we can save the collector some work by
      # sending integers instead of strings the next time around
      def fill_metric_id_cache(pairs_of_specs_and_ids)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">HighComplexity</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache has a flog score of 27          </span>  </li></ul>
        pairs_of_specs_and_ids.each do |_, value|
          if value.is_a? Array
            value.each do |array|<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Nested-Iterators.md" target="_blank">NestedIterators</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache contains iterators nested 2 deep          </span>  </li></ul>
              if array.is_a? Array<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache refers to array more than self (maybe move it to another class?)                        <a href="upload_service.html#L100" class="js-smell-location">0</a>                  <a href="upload_service.html#L101" class="js-smell-location">1</a>                  </span>  </li></ul>
                metric_id_cache[array[0][&#39;name&#39;].hash ^ (array[0][&#39;parent&#39;]||EMPTY_PARENT).hash] = array[1]<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache calls array[0] 2 times          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache refers to array more than self (maybe move it to another class?)                        <a href="upload_service.html#L100" class="js-smell-location">0</a>                  <a href="upload_service.html#L101" class="js-smell-location">1</a>                  </span>  </li></ul>
              end
            end
          end
        end
      rescue =&gt; e<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md" target="_blank">UncommunicativeVariableName</a>)      TingYun::TingYunService::UploadService#fill_metric_id_cache has the variable name 'e'          </span>  </li></ul>
        # If we&#39;ve gotten this far, we don&#39;t want this error to propagate and
        # make this post appear to have been non-successful, which would trigger
        # re-aggregation of the same metric data into the next post, so just log
        TingYun::Agent.logger.error(&quot;Failed to fill metric ID cache from response, error details follow &quot;, e)
      end
    end

    def error_data(unsent_errors)
      upload_data = {
          :type =&gt; &#39;errorTraceData&#39;,
          :errors =&gt; unsent_errors
      }
      invoke_remote(:upload, [upload_data], :encoder=&gt; json)
    end


    def action_trace_data(traces)
      upload_data = {
          :type =&gt; &#39;actionTraceData&#39;,
          :actionTraces =&gt; traces
      }
      invoke_remote(:upload, [upload_data], :encoder=&gt; json)
    end


    def sql_trace(sql_trace)
      upload_data = {
          :type =&gt; &#39;sqlTraceData&#39;,
          :sqlTraces =&gt; sql_trace
      }

      invoke_remote(:upload, [upload_data], :encoder=&gt; json)

    end

    def external_error_data(traces)
      upload_data = {
          :type =&gt; &#39;externalErrorTraceData&#39;,
          :errors =&gt; traces
      }
      invoke_remote(:upload, [upload_data], :encoder=&gt; json)
    end
  end
end
</code>

    </div>
    <script src='../../../../assets/javascripts/jquery-2.1.0.js'></script>
    <script src='../../../../assets/javascripts/jquery.tablesorter.js'></script>
    <script src='../../../../assets/javascripts/jquery.floatThead-v1.2.7.js'></script>
    <script src='../../../../assets/javascripts/jquery.timeago-v1.4.1.js'></script>
    <script src='../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../assets/javascripts/jquery.scrollTo-1.4.11.js'></script>
    <script src='../../../../assets/javascripts/prettify-4-Mar-2013.js'></script>
    <script src='../../../../assets/javascripts/application.js'></script>
  </body>
</html>
