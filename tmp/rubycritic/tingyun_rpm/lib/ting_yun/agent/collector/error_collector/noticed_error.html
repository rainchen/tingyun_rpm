<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>RubyCritic</title>
    <link href="../../../../../../assets/stylesheets/application.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <link href="../../../../../../assets/stylesheets/prettify.custom_theme.css" media="screen, projection, print" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <header class="project-header group">
      <div class="container">
        <h1 class="logo"><a href="../../../../../../overview.html" class="logo-link">RubyCritic</a></h1>
        <nav class="project-nav">
          <a href="../../../../../../overview.html" class="project-nav-item">Overview</a>
          <a href="../../../../../../code_index.html" class="project-nav-item">Code</a>
          <a href="../../../../../../smells_index.html" class="project-nav-item">Smells</a>
        </nav>
      </div>
    </header>
    <div class="container">
      <div class="file-header group rated">
  <span class="rating rating-b circled-text circle">
    B
  </span>
  <h2 class="file-name">TingYun::Agent::Collector::NoticedError</h2>

  <span class="file-committed-at">
    
      Updated <time class='js-timeago' datetime='2016-07-28 11:53:16 +0800'>2016-07-28 11:53:16 +0800</time>
    
  </span>

  <div class="file-stats group">
    <div class="file-stat">
      116 complexity
    </div>
    <div class="file-stat">
      19.3 complexity per method
    </div>
    <div class="file-stat">
      27 churn
    </div>
    <div class="file-stat">
      6 methods
    </div>
    <div class="file-stat">
      0 duplication
    </div>
  </div>

  
    <button id="js-toggle-smells" class="smells-toggle-button button">Toggle Smells</button>
  
</div>

<code class="prettyprint linenums lang-ruby file-code js-file-code"># encoding: utf-8

# A Hash-like class for storing errorTraceData data.
#

require &#39;ting_yun/support/exception&#39;
require &#39;ting_yun/support/coerce&#39;


module TingYun
  module Agent
    module Collector
      class NoticedError<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Irresponsible-Module.md" target="_blank">IrresponsibleModule</a>)      TingYun::Agent::Collector::NoticedError has no descriptive comment          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Too-Many-Instance-Variables.md" target="_blank">TooManyInstanceVariables</a>)      TingYun::Agent::Collector::NoticedError has at least 12 instance variables          </span>  </li></ul>

        attr_accessor :metric_name, :timestamp, :message, :exception_class_name,<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#exception_class_name is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#message is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#metric_name is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#timestamp is a writable attribute          </span>  </li></ul>
                      :request_uri, :request_port, :file_name, :line_number,<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#file_name is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#line_number is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#request_port is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#request_uri is a writable attribute          </span>  </li></ul>
                      :stack_trace, :attributes_from_notice_error, :attributes,<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#attributes is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#attributes_from_notice_error is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#stack_trace is a writable attribute          </span>  </li></ul>
                      :count_error, :thread_name, :is_external_error, :external_metric_name, :code, :trace<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#code is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#count_error is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#external_metric_name is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#is_external_error is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#thread_name is a writable attribute          </span>  </li>  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Attribute.md" target="_blank">Attribute</a>)      TingYun::Agent::Collector::NoticedError#trace is a writable attribute          </span>  </li></ul>


        attr_reader :exception_id, :is_internal


        def initialize(metric_name, exception, timestamp = Time.now)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">HighComplexity</a>)      TingYun::Agent::Collector::NoticedError#initialize has a flog score of 35          </span>  </li></ul>
          @stack_trace = []
          @count_error = 1
          @exception_id = exception.object_id
          @metric_name = metric_name
          @timestamp = timestamp
          @exception_class_name = exception.is_a?(Exception) ? exception.class.name : &#39;Error&#39;<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#initialize calls exception.class 2 times                        <a href="noticed_error.html#L30" class="js-smell-location">0</a>                  <a href="noticed_error.html#L39" class="js-smell-location">1</a>                  </span>  </li></ul>
          @external_metric_name = exception.instance_variable_get :@tingyun_klass
          @is_external_error = exception.instance_variable_get :@tingyun_external
          @code = exception.instance_variable_get :@tingyun_code
          @trace = exception.instance_variable_get :@tingyun_trace
          # It&#39;s critical that we not hold onto the exception class constant in this
          # class. These objects get serialized for Resque to a process that might
          # not have the original exception class loaded, so do all processing now
          # while we have the actual exception!
          @is_internal = (exception.class &lt; TingYun::Support::Exception::InternalAgentError)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#initialize calls exception.class 2 times                        <a href="noticed_error.html#L30" class="js-smell-location">0</a>                  <a href="noticed_error.html#L39" class="js-smell-location">1</a>                  </span>  </li></ul>

          if exception.nil?<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Nil-Check.md" target="_blank">NilCheck</a>)      TingYun::Agent::Collector::NoticedError#initialize performs a nil-check          </span>  </li></ul>
            @message = &#39;&lt;no message&gt;&#39;
          elsif exception.respond_to?(&#39;original_exception&#39;)
            @message = (exception.original_exception || exception).to_s
          else # exception is not nil, but does not respond to original_exception
            @message = exception.to_s
          end


          unless @message.is_a?(String)
            # In pre-1.9.3, Exception.new({}).to_s.class != String
            # That is, Exception#to_s may not return a String instance if one wasn&#39;t
            # passed in upon creation of the Exception. So, try to generate a useful
            # String representation of the exception message, falling back to failsafe
            @message = String(@message.inspect) rescue &#39;&lt;unknown message type&gt;&#39;
          end

          # clamp long messages to 4k so that we don&#39;t send a lot of
          # overhead across the wire
          @message = @message[0..4095] if @message.length &gt; 4096
        end


        def ==(other)
          if other.respond_to?(:exception_id)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::Agent::Collector::NoticedError#== refers to other more than self (maybe move it to another class?)                        <a href="noticed_error.html#L65" class="js-smell-location">0</a>                  <a href="noticed_error.html#L66" class="js-smell-location">1</a>                  </span>  </li></ul>
            exception_id == other.exception_id<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Feature-Envy.md" target="_blank">FeatureEnvy</a>)      TingYun::Agent::Collector::NoticedError#== refers to other more than self (maybe move it to another class?)                        <a href="noticed_error.html#L65" class="js-smell-location">0</a>                  <a href="noticed_error.html#L66" class="js-smell-location">1</a>                  </span>  </li></ul>
          else
            false
          end
        end

        include TingYun::Support::Coerce

        def to_collector_array(encoder)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="http://docs.seattlerb.org/flog/" target="_blank">HighComplexity</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array has a flog score of 41          </span>  </li></ul>
          if  is_external_error<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank">RepeatedConditional</a>)      TingYun::Agent::Collector::NoticedError tests is_external_error at least 3 times                        <a href="noticed_error.html#L75" class="js-smell-location">0</a>                  <a href="noticed_error.html#L101" class="js-smell-location">1</a>                  <a href="noticed_error.html#L112" class="js-smell-location">2</a>                  </span>  </li></ul>
            [timestamp.to_i,<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls timestamp.to_i 2 times                        <a href="noticed_error.html#L76" class="js-smell-location">0</a>                  <a href="noticed_error.html#L85" class="js-smell-location">1</a>                  </span>  </li></ul>
             string(external_metric_name),
             int(code),
             string(exception_class_name),<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls string(exception_class_name) 2 times                        <a href="noticed_error.html#L79" class="js-smell-location">0</a>                  <a href="noticed_error.html#L88" class="js-smell-location">1</a>                  </span>  </li></ul>
             count_error,
             string(metric_name),<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls string(metric_name) 2 times                        <a href="noticed_error.html#L81" class="js-smell-location">0</a>                  <a href="noticed_error.html#L86" class="js-smell-location">1</a>                  </span>  </li></ul>
             encoder.encode(error_params)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls encoder.encode(error_params) 2 times                        <a href="noticed_error.html#L82" class="js-smell-location">0</a>                  <a href="noticed_error.html#L92" class="js-smell-location">1</a>                  </span>  </li></ul>
            ]
          else
            [timestamp.to_i,<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls timestamp.to_i 2 times                        <a href="noticed_error.html#L76" class="js-smell-location">0</a>                  <a href="noticed_error.html#L85" class="js-smell-location">1</a>                  </span>  </li></ul>
             string(metric_name),<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls string(metric_name) 2 times                        <a href="noticed_error.html#L81" class="js-smell-location">0</a>                  <a href="noticed_error.html#L86" class="js-smell-location">1</a>                  </span>  </li></ul>
             int(attributes.agent_attributes[:httpStatus]),
             string(exception_class_name),<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls string(exception_class_name) 2 times                        <a href="noticed_error.html#L79" class="js-smell-location">0</a>                  <a href="noticed_error.html#L88" class="js-smell-location">1</a>                  </span>  </li></ul>
             string(message),
             count_error,
             string(request_uri),
             encoder.encode(error_params)<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#to_collector_array calls encoder.encode(error_params) 2 times                        <a href="noticed_error.html#L82" class="js-smell-location">0</a>                  <a href="noticed_error.html#L92" class="js-smell-location">1</a>                  </span>  </li></ul>
            ]
          end
        end

        def error_params
         hash = {
              :params =&gt; custom_params
          }
         if is_external_error<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank">RepeatedConditional</a>)      TingYun::Agent::Collector::NoticedError tests is_external_error at least 3 times                        <a href="noticed_error.html#L75" class="js-smell-location">0</a>                  <a href="noticed_error.html#L101" class="js-smell-location">1</a>                  <a href="noticed_error.html#L112" class="js-smell-location">2</a>                  </span>  </li></ul>
           hash[:stacktrace] = trace
         else
           hash[:stacktrace] = stack_trace
           hash[:requestParams] = request_params
         end
         hash
        end

        def custom_params
          hash = {:threadName =&gt; string(attributes.agent_attributes[:threadName])}<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#custom_params calls attributes.agent_attributes 3 times                        <a href="noticed_error.html#L111" class="js-smell-location">0</a>                  <a href="noticed_error.html#L115" class="js-smell-location">1</a>                  <a href="noticed_error.html#L116" class="js-smell-location">2</a>                  </span>  </li></ul>
          if is_external_error<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Repeated-Conditional.md" target="_blank">RepeatedConditional</a>)      TingYun::Agent::Collector::NoticedError tests is_external_error at least 3 times                        <a href="noticed_error.html#L75" class="js-smell-location">0</a>                  <a href="noticed_error.html#L101" class="js-smell-location">1</a>                  <a href="noticed_error.html#L112" class="js-smell-location">2</a>                  </span>  </li></ul>
            hash[:httpStatus] = int(code)
          else
            hash[:httpStatus] = int(attributes.agent_attributes[:httpStatus])<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#custom_params calls attributes.agent_attributes 3 times                        <a href="noticed_error.html#L111" class="js-smell-location">0</a>                  <a href="noticed_error.html#L115" class="js-smell-location">1</a>                  <a href="noticed_error.html#L116" class="js-smell-location">2</a>                  </span>  </li></ul>
            hash[:referer] = string(attributes.agent_attributes[:referer]) || &#39;&#39;<ul class="nocode smells js-smells">  <li class="smell ">    <span class="description">      (<a href="https://github.com/troessner/reek/blob/master/docs/Duplicate-Method-Call.md" target="_blank">DuplicateMethodCall</a>)      TingYun::Agent::Collector::NoticedError#custom_params calls attributes.agent_attributes 3 times                        <a href="noticed_error.html#L111" class="js-smell-location">0</a>                  <a href="noticed_error.html#L115" class="js-smell-location">1</a>                  <a href="noticed_error.html#L116" class="js-smell-location">2</a>                  </span>  </li></ul>
          end
          hash
        end

        def request_params
          return {}  unless TingYun::Agent.config[&#39;nbs.capture_params&#39;]
          attributes.request_params
        end

      end
    end
  end
end

</code>

    </div>
    <script src='../../../../../../assets/javascripts/jquery-2.1.0.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.tablesorter.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.floatThead-v1.2.7.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.timeago-v1.4.1.js'></script>
    <script src='../../../../../../assets/javascripts/highcharts.src-4.0.1.js'></script>
    <script src='../../../../../../assets/javascripts/jquery.scrollTo-1.4.11.js'></script>
    <script src='../../../../../../assets/javascripts/prettify-4-Mar-2013.js'></script>
    <script src='../../../../../../assets/javascripts/application.js'></script>
  </body>
</html>
